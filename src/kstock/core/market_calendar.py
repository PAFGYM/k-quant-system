"""í•œêµ­ ì¦ì‹œ ë§ˆì¼“ ìº˜ë¦°ë”.

ì£¼ë§ + ê³µíœ´ì¼ + ì„ì‹œê³µíœ´ì¼ ì²´í¬.
ë§¤ë…„ ê°±ì‹  í•„ìš”: KR_HOLIDAYS dictì— ì—°ë„ë³„ ì¶”ê°€.
"""
from __future__ import annotations

from datetime import date, timedelta

# â”€â”€ í•œêµ­ ê³µíœ´ì¼ (ì—°ë„ë³„) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ìŒë ¥ íœ´ì¼(ì„¤/ì¶”ì„)ì€ ë§¤ë…„ ë‚ ì§œê°€ ë‹¤ë¥´ë¯€ë¡œ ì§ì ‘ ì…ë ¥.
# ëŒ€ì²´ê³µíœ´ì¼Â·ì„ì‹œê³µíœ´ì¼ë„ í¬í•¨.

KR_HOLIDAYS: dict[int, set[tuple[int, int]]] = {
    2025: {
        (1, 1),    # ì‹ ì •
        (1, 28),   # ì„¤ ì—°íœ´
        (1, 29),   # ì„¤ë‚ 
        (1, 30),   # ì„¤ ì—°íœ´
        (3, 1),    # ì‚¼ì¼ì ˆ
        (5, 5),    # ì–´ë¦°ì´ë‚ 
        (5, 6),    # ì„ê°€íƒ„ì‹ ì¼
        (6, 6),    # í˜„ì¶©ì¼
        (8, 15),   # ê´‘ë³µì ˆ
        (10, 5),   # ì¶”ì„ ì—°íœ´
        (10, 6),   # ì¶”ì„
        (10, 7),   # ì¶”ì„ ì—°íœ´
        (10, 8),   # ì¶”ì„ ëŒ€ì²´ê³µíœ´ì¼
        (10, 3),   # ê°œì²œì ˆ
        (10, 9),   # í•œê¸€ë‚ 
        (12, 25),  # ì„±íƒ„ì ˆ
    },
    2026: {
        (1, 1),    # ì‹ ì •
        (2, 16),   # ì„¤ ì—°íœ´
        (2, 17),   # ì„¤ë‚ 
        (2, 18),   # ì„¤ ì—°íœ´
        (2, 19),   # ì„¤ ëŒ€ì²´ê³µíœ´ì¼ (ìˆ˜â†’ëª©)
        (3, 1),    # ì‚¼ì¼ì ˆ (ì¼) â†’ 3/2 ëŒ€ì²´
        (3, 2),    # ì‚¼ì¼ì ˆ ëŒ€ì²´ê³µíœ´ì¼
        (5, 5),    # ì–´ë¦°ì´ë‚ 
        (5, 24),   # ì„ê°€íƒ„ì‹ ì¼ (ì¼) â†’ 5/25 ëŒ€ì²´
        (5, 25),   # ì„ê°€íƒ„ì‹ ì¼ ëŒ€ì²´ê³µíœ´ì¼
        (6, 6),    # í˜„ì¶©ì¼ (í† ) â†’ ëŒ€ì²´ ì—†ìŒ
        (8, 15),   # ê´‘ë³µì ˆ (í† ) â†’ ëŒ€ì²´ ì—†ìŒ
        (9, 24),   # ì¶”ì„ ì—°íœ´
        (9, 25),   # ì¶”ì„
        (9, 26),   # ì¶”ì„ ì—°íœ´
        (10, 3),   # ê°œì²œì ˆ (í† ) â†’ ëŒ€ì²´ ì—†ìŒ
        (10, 9),   # í•œê¸€ë‚ 
        (12, 25),  # ì„±íƒ„ì ˆ
    },
    2027: {
        (1, 1),    # ì‹ ì •
        (2, 6),    # ì„¤ ì—°íœ´
        (2, 7),    # ì„¤ë‚  (ì¼) â†’ 2/8 ëŒ€ì²´
        (2, 8),    # ì„¤ ì—°íœ´/ëŒ€ì²´
        (2, 9),    # ì„¤ ëŒ€ì²´ê³µíœ´ì¼
        (3, 1),    # ì‚¼ì¼ì ˆ
        (5, 5),    # ì–´ë¦°ì´ë‚ 
        (5, 13),   # ì„ê°€íƒ„ì‹ ì¼
        (6, 6),    # í˜„ì¶©ì¼ (ì¼) â†’ 6/7 ëŒ€ì²´
        (6, 7),    # í˜„ì¶©ì¼ ëŒ€ì²´ê³µíœ´ì¼
        (8, 15),   # ê´‘ë³µì ˆ (ì¼) â†’ 8/16 ëŒ€ì²´
        (8, 16),   # ê´‘ë³µì ˆ ëŒ€ì²´ê³µíœ´ì¼
        (9, 14),   # ì¶”ì„ ì—°íœ´
        (9, 15),   # ì¶”ì„
        (9, 16),   # ì¶”ì„ ì—°íœ´
        (10, 3),   # ê°œì²œì ˆ (ì¼) â†’ 10/4 ëŒ€ì²´
        (10, 4),   # ê°œì²œì ˆ ëŒ€ì²´ê³µíœ´ì¼
        (10, 9),   # í•œê¸€ë‚  (í† ) â†’ ëŒ€ì²´ ì—†ìŒ
        (12, 25),  # ì„±íƒ„ì ˆ (í† ) â†’ ëŒ€ì²´ ì—†ìŒ
    },
}

# ì„ì‹œê³µíœ´ì¼ (ì •ë¶€ ì§€ì • ì‹œ ì¶”ê°€)
TEMP_HOLIDAYS: set[date] = set()


def is_kr_holiday(d: date | None = None) -> bool:
    """ì£¼ì–´ì§„ ë‚ ì§œê°€ í•œêµ­ ê³µíœ´ì¼ì¸ì§€ í™•ì¸."""
    if d is None:
        d = date.today()
    if d in TEMP_HOLIDAYS:
        return True
    year_holidays = KR_HOLIDAYS.get(d.year, set())
    return (d.month, d.day) in year_holidays


def is_kr_market_open(d: date | None = None) -> bool:
    """ì£¼ì–´ì§„ ë‚ ì§œì— í•œêµ­ ì£¼ì‹ì‹œì¥ì´ ê°œì¥í•˜ëŠ”ì§€ í™•ì¸.

    False: ì£¼ë§ ë˜ëŠ” ê³µíœ´ì¼
    True: í‰ì¼ì´ê³  ê³µíœ´ì¼ì´ ì•„ë‹Œ ë‚ 
    """
    if d is None:
        d = date.today()
    # ì£¼ë§ ì²´í¬
    if d.weekday() >= 5:  # 5=í† , 6=ì¼
        return False
    # ê³µíœ´ì¼ ì²´í¬
    if is_kr_holiday(d):
        return False
    return True


def next_market_day(d: date | None = None) -> date:
    """ë‹¤ìŒ ê°œì¥ì¼ ë°˜í™˜."""
    if d is None:
        d = date.today()
    d = d + timedelta(days=1)
    while not is_kr_market_open(d):
        d += timedelta(days=1)
    return d


def market_status_text(d: date | None = None) -> str:
    """ì˜¤ëŠ˜ ì‹œì¥ ìƒíƒœë¥¼ í…ìŠ¤íŠ¸ë¡œ ë°˜í™˜."""
    if d is None:
        d = date.today()
    if is_kr_market_open(d):
        return ""
    if d.weekday() >= 5:
        day_name = "í† ìš”ì¼" if d.weekday() == 5 else "ì¼ìš”ì¼"
        return f"ğŸ“… ì˜¤ëŠ˜ì€ {day_name} â€” êµ­ë‚´ ì£¼ì‹ì‹œì¥ íœ´ì¥"
    # ê³µíœ´ì¼
    return "ğŸ“… ì˜¤ëŠ˜ì€ ê³µíœ´ì¼ â€” êµ­ë‚´ ì£¼ì‹ì‹œì¥ íœ´ì¥"
